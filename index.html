
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ramallah Waste Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Turf for spatial analysis -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --bg: #f5f7fa;
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #2b8a78;
  --accent-2: #4aa3a0;
  --soft: #e6eef0;
  --danger: #e06464;
  --glass: rgba(255,255,255,0.75);
  --round: 10px;
  --shadow: 0 6px 18px rgba(20,30,40,0.08);
}

html,body,#map { height: 100%; margin:0; padding:0; font-family: Inter, ui-sans-serif, system-ui; background: var(--bg); color: #0f172a; }

/* Top controls */
.topbar {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: 12px;
  display:flex;
  gap:12px;
  z-index: 1200;
  align-items:center;
  backdrop-filter: blur(6px);
  background: var(--glass);
  border-radius: 12px;
  padding: 8px 12px;
  box-shadow: var(--shadow);
}
.stat { display:flex; flex-direction:column; align-items:center; padding:6px 12px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,250,0.85)); min-width:110px; }
.stat .num { font-weight:700; font-size:18px; color: var(--accent); }
.stat .label { font-size:12px; color:var(--muted); margin-top:4px; }
.controls { display:flex; gap:8px; align-items:center; }
.btn { background: var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; box-shadow: 0 4px 10px rgba(43,138,120,0.18); font-weight:600; }
.btn.secondary { background:transparent; color:var(--accent); border:1px solid rgba(43,138,120,0.14); box-shadow:none; }

/* Map */
#map { position:absolute; inset:0; z-index:0; }

/* Sidebar */
.sidebar { position: absolute; top: 72px; bottom: 18px; width: 340px; z-index: 1300; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98)); box-shadow: var(--shadow); border-radius: 12px; overflow:auto; transition: transform .28s cubic-bezier(.2,.9,.3,1), right .28s; padding: 14px; }
.sidebar.hidden { transform: translateX(110%); }
.sidebar.right { right: 18px; transform: translateX(110%); direction: rtl; }
.sidebar.open { transform: translateX(0); }
.sidebar h3 { margin:0 0 8px 0; color:#0f172a; }
.sidebar .meta { font-size:13px; color:var(--muted); margin-bottom:6px; }
.close-x { float:right; background:transparent; border:none; font-size:18px; cursor:pointer; color:var(--muted); }

/* Legend */
.legend { position:absolute; left:12px; bottom:18px; z-index:1200; background:var(--card); padding:10px 12px; border-radius:10px; box-shadow: var(--shadow); font-size:13px; color:var(--muted); }
.legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
.swatch { width:18px; height:12px; border-radius:4px; }

/* Coordinates display */
.coordinates { font-size:13px; background: rgba(255,255,255,0.8); padding:4px 8px; border-radius:6px; color:#0f172a; }

/* Splash Screen */
#splash { position:absolute; inset:0; z-index:2000; background:#2b8a78; display:flex; justify-content:center; align-items:center; color:white; font-size:24px; font-weight:700; transition: opacity 1s ease; }
.splash-hidden { opacity:0; pointer-events:none; }
</style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash">ğŸŒ Ramallah Waste Management Explorer</div>

<div class="topbar" id="topbar">
  <div class="stat"><div class="num" id="zonesCount">â€”</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div></div>
  <div class="stat"><div class="num" id="containersCount">â€”</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª</div></div>
  <div style="width:12px"></div>
  <div class="controls">
    <button class="btn" id="zoomTopBtn" title="Zoom to zone with most containers">Zoom â–¶ Ø£ÙƒØ¨Ø± Ù…Ù†Ø·Ù‚Ø©</button>
    <button class="btn secondary" id="toggleLegend">Legend</button>
    <button class="btn" id="autoExploreBtn">Auto Explore â–¶</button>
    <button class="btn secondary" id="stopExploreBtn">Stop</button>
  </div>
</div>

<div id="map"></div>

<!-- Sidebar -->
<div id="sidebar" class="sidebar right hidden">
  <button class="close-x" id="closeSidebar">âœ•</button>
  <h3 id="sidebarTitle">ØªÙØ§ØµÙŠÙ„</h3>
  <div class="meta" id="sidebarMeta">Ø¥Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø­Ø§ÙˆÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
  <div id="sidebarContent"></div>
  <div style="margin-top:12px;">
    <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ (Ù…Ø­Ø§ÙƒØ§Ø©)</div>
    <div class="analyze-area">
      <input id="aiInput" class="text-input" placeholder="Ø§ÙƒØªØ¨: Ø­Ù„Ù‘Ù„Ù„ÙŠ Ø£Ù…Ø§ÙƒÙ† ÙÙŠÙ‡Ø§ Ù‚Ù„Ø© Ø­Ø§ÙˆÙŠØ§Øª" />
      <button class="btn" id="analyzeBtn">Ø­Ù„Ù‘Ù„</button>
    </div>
  </div>
</div>

<!-- Legend -->
<div id="legend" class="legend" style="display:none;">
  <div style="font-weight:700; margin-bottom:6px;">Legend</div>
  <div class="row"><div class="swatch" style="background: #fde68a"></div><div>Ù…Ù†Ø·Ù‚Ø© (Ù†Ø³Ø¨Ø© Ø­Ø§ÙˆÙŠØ§Øª Ù…Ù†Ø®ÙØ¶Ø©)</div></div>
  <div class="row"><div class="swatch" style="background: #a7f3d0"></div><div>Ù…Ù†Ø·Ù‚Ø© (ÙƒØ«Ø§ÙØ© Ù…ØªÙˆØ³Ø·Ø©/Ù…Ø±ØªÙØ¹Ø©)</div></div>
  <div class="row"><div class="swatch" style="background: orange"></div><div>Ø­Ø§ÙˆÙŠØ§Øª</div></div>
</div>

<!-- Comment Box -->
<div id="commentBox" style="
    position:absolute;
    bottom:80px;
    right:12px;
    z-index:1400;
    background:white;
    padding:10px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    width:240px;
    font-size:13px;
    max-height:200px;
    overflow:auto;
">
  <div style="font-weight:700; margin-bottom:6px;">ğŸ’¬ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
  <textarea id="commentInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ..." style="width:100%; height:60px; border-radius:6px; border:1px solid #ccc; padding:6px; resize:none;"></textarea>
  <button id="addCommentBtn" class="btn" style="margin-top:6px; width:100%;">Ø£Ø¶Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
  <div id="commentsList" style="margin-top:6px;"></div>
</div>

<script>
const ZONES_FILE = 'RamallahZones.json';
const CONTAINERS_FILE = 'wasteContainer.json';

// Map
const map = L.map('map', { zoomSnap: 0.25 }).setView([31.9045, 35.2045], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }).addTo(map);

// ===== Coordinates Display =====
const coordsDiv = L.control({position: 'bottomleft'});
coordsDiv.onAdd = function(map){
  this._div = L.DomUtil.create('div', 'coordinates');
  this._div.innerHTML = 'Lat: -, Lng: -';
  return this._div;
};
coordsDiv.addTo(map);
map.on('mousemove', function(e){
  coordsDiv._div.innerHTML = `Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}`;
});

// ===== Scale in Kilometers =====
L.control.scale({ metric: true, imperial: false, position: 'bottomright' }).addTo(map);

// Global
let zonesLayer=null, containersLayer=null, zonesGeoJSON=null, containersGeoJSON=null;
const lowZoneIds = new Set();
let stopAutoExplore = false;

// UI Elements
const zonesCountEl = document.getElementById('zonesCount');
const containersCountEl = document.getElementById('containersCount');
const closeSidebarBtn = document.getElementById('closeSidebar');
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebarContent');
const sidebarMeta = document.getElementById('sidebarMeta');
const aiInput = document.getElementById('aiInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const zoomTopBtn = document.getElementById('zoomTopBtn');
const legendEl = document.getElementById('legend');
const toggleLegendBtn = document.getElementById('toggleLegend');
const autoExploreBtn = document.getElementById('autoExploreBtn');
const stopExploreBtn = document.getElementById('stopExploreBtn');
const splash = document.getElementById('splash');

// Comment Box
const commentInput = document.getElementById('commentInput');
const addCommentBtn = document.getElementById('addCommentBtn');
const commentsList = document.getElementById('commentsList');
addCommentBtn.addEventListener('click', ()=>{
  const text = commentInput.value.trim();
  if(!text) return;
  const div = document.createElement('div');
  div.style.padding="4px 6px"; div.style.marginBottom="4px"; div.style.borderBottom="1px dashed #eee";
  div.textContent = "â€¢ " + text;
  commentsList.prepend(div);
  commentInput.value="";
});

// Splash screen fade
window.addEventListener('load', ()=>{ setTimeout(()=>{ splash.classList.add('splash-hidden'); },2000); });

// Sidebar functions
function openSidebar(){ sidebar.classList.remove('hidden'); sidebar.classList.add('open'); }
function closeSidebar(){ sidebar.classList.add('hidden'); sidebar.classList.remove('open'); }
closeSidebarBtn.addEventListener('click', closeSidebar);

// Toggle legend
toggleLegendBtn.addEventListener('click', ()=>{ legendEl.style.display = legendEl.style.display==='none'?'block':'none'; });

// Load data
async function loadData(){
  const [zonesResp, contResp] = await Promise.all([fetch(ZONES_FILE), fetch(CONTAINERS_FILE)]);
  zonesGeoJSON = await zonesResp.json();
  containersGeoJSON = await contResp.json();
  buildContainersLayer(); buildZonesLayer();
  zonesCountEl.textContent = zonesGeoJSON.features.length;
  containersCountEl.textContent = containersGeoJSON.features.length;
  zonesLayer.addTo(map); containersLayer.addTo(map);
  fitMapToData();
}
function fitMapToData(){ map.fitBounds(L.featureGroup([zonesLayer,containersLayer]).getBounds(),{padding:[30,30]}); }

// Layers
function buildContainersLayer(){
  containersLayer = L.geoJSON(containersGeoJSON,{
    pointToLayer: (f,l)=>L.circleMarker(l,{radius:5,fillColor:'orange',color:'orange',weight:1,opacity:1,fillOpacity:0.9}),
    onEachFeature: (f,l)=>{ l.bindPopup(`Container: ${f.properties.ID||'-'}`); l.on('click',()=>showSidebarFor('container',f.properties)); }
  });
}
function buildZonesLayer(){
  zonesLayer = L.geoJSON(zonesGeoJSON,{
    style: f=>{ const id=f.properties.ID||f.properties.MAIL_CODE||f.properties.NAME_ENGLI||Math.random(); const base={fillColor:'#a7f3d0',fillOpacity:0.35,color:'#9ae6b4',weight:1,opacity:0.9}; if(lowZoneIds.has(id)) return {...base,fillColor:'#fde68a',color:'#facc15'}; return base; },
    onEachFeature: (f,l)=>{ l.bindPopup(`Zone: ${f.properties.NAME||'-'}`); l.on('click',()=>showSidebarFor('zone',f.properties)); }
  });
}

// Sidebar content
function showSidebarFor(type, properties){
  openSidebar();
  const title = properties.NAME_ENGLI||properties.NAME||(type==='zone'?'Zone':'Container');
  sidebarContent.innerHTML = `<div><b>${title}</b></div>`;
}

// Auto Explore
autoExploreBtn.addEventListener('click',()=>{ stopAutoExplore=false; autoExplore(); });
stopExploreBtn.addEventListener('click',()=>{ stopAutoExplore=true; });
async function autoExplore(){
  const layers=[...zonesLayer.getLayers(), ...containersLayer.getLayers()];
  for(let i=0;i<layers.length;i++){
    if(stopAutoExplore) break;
    const l=layers[i];
    map.flyToBounds(l.getBounds ? l.getBounds() : L.latLngBounds(l.getLatLng(), l.getLatLng()),{duration:2});
    showSidebarFor(l.feature.geometry.type==='Polygon'?'zone':'container', l.feature.properties);
    await new Promise(r=>setTimeout(r,2500));
  }
}

// Load initial data
loadData();
</script>
</body>
</html>

