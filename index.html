<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ramallah Waste Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Turf for spatial analysis -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --bg: #f5f7fa;
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #2b8a78;
  --soft: #e6eef0;
  --danger: #e06464;
  --glass: rgba(255,255,255,0.75);
  --round: 10px;
  --shadow: 0 6px 18px rgba(20,30,40,0.08);
}

html,body,#map { height: 100%; margin:0; padding:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg); color: #0f172a; }

.topbar {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: 12px;
  display:flex;
  gap:12px;
  z-index: 1200;
  align-items:center;
  backdrop-filter: blur(6px);
  background: var(--glass);
  border-radius: 12px;
  padding: 8px 12px;
  box-shadow: var(--shadow);
}
.stat { display:flex; flex-direction:column; align-items:center; padding:6px 12px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,250,0.85)); min-width:110px; }
.stat .num { font-weight:700; font-size:18px; color: var(--accent); }
.stat .label { font-size:12px; color:var(--muted); margin-top:4px; }

.controls { display:flex; gap:8px; align-items:center; }
.btn { background: var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; box-shadow: 0 4px 10px rgba(43,138,120,0.18); font-weight:600; }
.btn.secondary { background:transparent; color:var(--accent); border:1px solid rgba(43,138,120,0.14); box-shadow:none; }

#map { position:absolute; inset:0; z-index:0; }

.sidebar {
  position: absolute;
  top: 72px;
  bottom: 18px;
  width: 340px;
  z-index: 1300;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98));
  box-shadow: var(--shadow);
  border-radius: 12px;
  overflow:auto;
  transition: transform .28s cubic-bezier(.2,.9,.3,1), right .28s;
  padding: 14px;
}
.sidebar.hidden { transform: translateX(110%); }
.sidebar.right { right: 18px; }
.sidebar.open { transform: translateX(0); }
.sidebar h3 { margin:0 0 8px 0; color:#0f172a; }
.sidebar .meta { font-size:13px; color:var(--muted); margin-bottom:6px; }
.close-x { float:right; background:transparent; border:none; font-size:18px; cursor:pointer; color:var(--muted); }

.info-row { display:flex; gap:8px; align-items:center; padding:8px 0; border-bottom:1px dashed rgba(15,23,42,0.05); }
.icon-box { width:44px; height:44px; border-radius:8px; background:var(--soft); display:flex; align-items:center; justify-content:center; }
.info-key { font-size:13px; color:var(--muted); }
.info-val { font-weight:700; color:#0b1220; }

.analyze-area { margin-top:10px; display:flex; gap:8px; }
.text-input { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:white; }

.legend {
  position:absolute; left:12px; bottom:18px; z-index:1200;
  background:var(--card); padding:10px 12px; border-radius:10px; box-shadow: var(--shadow);
  font-size:13px; color:var(--muted);
}
.legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
.swatch { width:18px; height:12px; border-radius:4px; }

.leaflet-popup-content-wrapper { border-radius:10px; box-shadow:var(--shadow); }
.popup-title { font-weight:700; margin-bottom:6px; color:#072020; display:flex; gap:8px; align-items:center; }

.splash-screen {
  position:absolute;
  top:0; left:0; width:100%; height:100%;
  background: var(--accent);
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  z-index:2000;
  opacity:1;
  transition: opacity 1s ease;
}
.splash-hidden { opacity:0; pointer-events:none; }

@media (max-width:720px){
  .sidebar { width: 86%; top:78px; padding:12px; }
  .topbar { left: 12px; transform:none; }
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash" class="splash-screen">ğŸŒ Ramallah Waste Management Explorer</div>

<!-- Top bar stats & controls -->
<div class="topbar" id="topbar">
  <div class="stat"><div class="num" id="zonesCount">â€”</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</div></div>
  <div class="stat"><div class="num" id="containersCount">â€”</div><div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª</div></div>
  <div class="controls">
    <button class="btn" id="zoomTopBtn" title="Zoom to top zone">ØªÙƒØ¨ÙŠØ± â–¶ Ø£ÙƒØ¨Ø± Ù…Ù†Ø·Ù‚Ø©</button>
    <button class="btn secondary" id="toggleLegend">Legend</button>
  </div>
</div>

<!-- Auto Explore & Stop Buttons -->
<div style="position:absolute; top:110px; left:50%; transform:translateX(-50%); z-index:1400; display:flex; gap:8px;">
  <button id="autoExploreBtn" class="btn">â–¶ Ø§Ø³ØªÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</button>
  <button id="stopExploreBtn" class="btn secondary">â–  Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù</button>
</div>

<div id="map"></div>

<div id="sidebar" class="sidebar right hidden" role="complementary" aria-hidden="true">
  <button class="close-x" id="closeSidebar" title="Close">âœ•</button>
  <h3 id="sidebarTitle">ØªÙØ§ØµÙŠÙ„</h3>
  <div class="meta" id="sidebarMeta">Ø¥Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø­Ø§ÙˆÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
  <div id="sidebarContent">
    <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ (Ù…Ø­Ø§ÙƒØ§Ø©)</div>
    <div class="analyze-area">
      <input id="aiInput" class="text-input" placeholder="Ø§ÙƒØªØ¨: Ø­Ù„Ù‘Ù„Ù„ÙŠ Ø£Ù…Ø§ÙƒÙ† ÙÙŠÙ‡Ø§ Ù‚Ù„Ø© Ø­Ø§ÙˆÙŠØ§Øª" />
      <button class="btn" id="analyzeBtn">Ø­Ù„Ù‘Ù„</button>
    </div>
  </div>
</div>

<div id="legend" class="legend" style="display:none;">
  <div style="font-weight:700; margin-bottom:6px;">Legend</div>
  <div class="row"><div class="swatch" style="background: #fde68a"></div><div>Ù…Ù†Ø·Ù‚Ø© (Ù†Ø³Ø¨Ø© Ø­Ø§ÙˆÙŠØ§Øª Ù…Ù†Ø®ÙØ¶Ø©)</div></div>
  <div class="row"><div class="swatch" style="background: #a7f3d0"></div><div>Ù…Ù†Ø·Ù‚Ø© (ÙƒØ«Ø§ÙØ© Ù…ØªÙˆØ³Ø·Ø©/Ù…Ø±ØªÙØ¹Ø©)</div></div>
  <div class="row"><div class="swatch" style="background: orange"></div><div>Ø­Ø§ÙˆÙŠØ§Øª</div></div>
</div>

<script>
const ZONES_FILE = 'RamallahZones.json';
const CONTAINERS_FILE = 'wasteContainer.json';

const map = L.map('map', { zoomSnap: 0.25 }).setView([31.9045, 35.2045], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{ maxZoom:20, attribution:'&copy; OpenStreetMap contributors &copy; CARTO' }).addTo(map);

let zonesLayer=null, containersLayer=null, zonesGeoJSON=null, containersGeoJSON=null, lowZoneIds=new Set();
let stopAutoExplore = false;

const zonesCountEl = document.getElementById('zonesCount');
const containersCountEl = document.getElementById('containersCount');
const closeSidebarBtn = document.getElementById('closeSidebar');
const sidebarContent = document.getElementById('sidebarContent');
const sidebarMeta = document.getElementById('sidebarMeta');
const aiInput = document.getElementById('aiInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const zoomTopBtn = document.getElementById('zoomTopBtn');
const toggleLegendBtn = document.getElementById('toggleLegend');
const autoExploreBtn = document.getElementById('autoExploreBtn');
const stopExploreBtn = document.getElementById('stopExploreBtn');

// Splash Screen
const splash = document.getElementById('splash');
window.addEventListener('load', ()=>{
  setTimeout(()=>{ splash.classList.add('splash-hidden'); }, 2000);
});

// Sidebar open/close
function openSidebar(){ sidebar.classList.remove('hidden'); sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); }
function closeSidebar(){ sidebar.classList.add('hidden'); sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); }
closeSidebarBtn.addEventListener('click', closeSidebar);

// Toggle Legend
toggleLegendBtn.addEventListener('click', ()=>{ legend.style.display = legend.style.display==='none' ? 'block' : 'none'; });

// Icons
function binIconSVG(size=18){ return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="3" width="6" height="2" fill="${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#2b8a78'}"/><path d="M6 7h12l-1 13a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L6 7z" fill="orange"/></svg>`;}
function zoneIconSVG(size=18){ return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" fill="#a7f3d0"/><path d="M7 12h10" stroke="#065f46" stroke-width="1.5" stroke-linecap="round"/></svg>`;}

// Popup template
function makePopupHTML(type, properties){
  const title = properties.NAME_ENGLI || properties.NAME || properties.TYPE_OF_WA || properties.name || 'â€”';
  const icon = type==='zone'? zoneIconSVG(20):binIconSVG(18);
  const propsList = Object.entries(properties).map(([k,v])=>`<div style="display:flex;justify-content:space-between;margin:4px 0;"><div style="color:var(--muted);font-size:13px">${k}</div><div style="font-weight:700">${v}</div></div>`).join('');
  const openSideBtnText = 'Open details';
  return `<div style="min-width:220px"><div class="popup-title">${icon}<div>${title}</div></div><div class="popup-body">${propsList}</div><div class="popup-actions"><button class="btn" onclick="openDetailsFromPopup('${type}','${encodeURIComponent(JSON.stringify(properties))}')">${openSideBtnText}</button></div></div>`;
}
window.openDetailsFromPopup = function(type, propsStr){ const props=JSON.parse(decodeURIComponent(propsStr)); showSidebarFor(type, props); };

// Load data
async function loadData(){
  try{
    const [zonesResp, contResp]=await Promise.all([fetch(ZONES_FILE), fetch(CONTAINERS_FILE)]);
    zonesGeoJSON=await zonesResp.json();
    containersGeoJSON=await contResp.json();
    buildContainersLayer(); buildZonesLayer();
    zonesCountEl.textContent = zonesGeoJSON.features.length;
    containersCountEl.textContent = containersGeoJSON.features.length;
    zonesLayer.addTo(map); containersLayer.addTo(map);
    fitMapToData();
  }catch(err){ alert('Error loading data: '+err.message); console.error(err); }
}
function fitMapToData(){ const fg=L.featureGroup([zonesLayer, containersLayer]); map.fitBounds(fg.getBounds(),{padding:[30,30]}); }

// Containers layer
function buildContainersLayer(){
  containersLayer = L.geoJSON(containersGeoJSON,{
    pointToLayer: (f,l)=>L.circleMarker(l,{radius:5, fillColor:'orange', color:'orange', weight:1, opacity:1, fillOpacity:0.9}),
    onEachFeature: (f,l)=>{ l.bindPopup(makePopupHTML('container',f.properties || {})); l.on('click',()=>showSidebarFor('container', f.properties)); }
  });
}

// Zones layer
function buildZonesLayer(){
  zonesLayer = L.geoJSON(zonesGeoJSON,{
    style: f=>{ const id=f.properties.ID||f.properties.MAIL_CODE||f.properties.NAME_ENGLI||Math.random(); const base={ fillColor:'#a7f3d0', fillOpacity:0.35, color:'#9ae6b4', weight:1, opacity:0.9 }; if(lowZoneIds.has(id)) return {...base, fillColor:'#fde68a', color:'#facc15'}; return base; },
    onEachFeature: (f,l)=>{ l.bindPopup(makePopupHTML('zone',f.properties || {})); l.on('click',()=>showSidebarFor('zone',f.properties)); }
  });
}

// Sidebar content
function showSidebarFor(type, properties){
  openSidebar();
  const title = properties.NAME_ENGLI||properties.NAME||(type==='zone'?'Zone':'Container');
  document.getElementById('sidebarTitle').textContent=title;
  sidebarMeta.textContent='Item details';
  let html=`<div class="info-row"><div class="icon-box">${type==='zone'? zoneIconSVG():binIconSVG()}</div><div style="flex:1"><div class="info-key">Name</div><div class="info-val">${title}</div></div></div>`;
  const skipKeys=['geometry'];
  for(const [k,v] of Object.entries(properties)){ if(skipKeys.includes(k)) continue; html+=`<div style="padding:8px 0;border-bottom:1px dashed rgba(15,23,42,0.04)"><div style="font-size:13px;color:var(--muted)">${k}</div><div style="font-weight:700">${v}</div></div>`; }
  html+=`<div style="margin-top:10px; display:flex; gap:8px;"><button class="btn" id="zoomToFeatureBtn">Zoom to item</button><button class="btn secondary" id="closeSideSmall">Close</button></div>`;
  sidebarContent.innerHTML=html;
  document.getElementById('zoomToFeatureBtn').addEventListener('click',()=>{
    let found=null;
    if(type==='zone') zonesLayer.eachLayer(l=>{ const p=l.feature && l.feature.properties; if(p && (p.NAME_ENGLI===properties.NAME_ENGLI||p.NAME===properties.NAME)) found=l; });
    else containersLayer.eachLayer(l=>{ const p=l.feature && l.feature.properties; if(p && (p.ID===properties.ID||p.TYPE_OF_WA===properties.TYPE_OF_WA)) found=l; });
    if(found) map.fitBounds(found.getBounds ? found.getBounds() : L.latLngBounds(found.getLatLng(), found.getLatLng()), { maxZoom:18, padding:[30,30] });
  });
  document.getElementById('closeSideSmall').addEventListener('click', closeSidebar);
}

// Counts per zone
function computeCountsPerZone(){ const zoneCounts={}; if(!zonesGeoJSON||!containersGeoJSON) return zoneCounts; const pts=containersGeoJSON; const polys=zonesGeoJSON; for(let i=0;i<polys.features.length;i++){ const poly=polys.features[i]; const pid=poly.properties.ID||poly.properties.MAIL_CODE||poly.properties.NAME_ENGLI||i; try{ const ptsWithin=turf.pointsWithinPolygon(pts,poly); zoneCounts[pid]=ptsWithin.features.length; }catch(e){ zoneCounts[pid]=0; } } return zoneCounts; }
function findTopZone(zoneCounts){ let maxId=null,maxCount=-1; for(const [k,v] of Object.entries(zoneCounts)){ if(v>maxCount){ maxCount=v; maxId=k; } } return {id:maxId,count:maxCount}; }

// Zoom top zone
zoomTopBtn.addEventListener('click',()=>{
  const counts=computeCountsPerZone();
  const top=findTopZone(counts);
  if(!top.id) return alert('No zones found');
  let targetLayer=null;
  zonesLayer.eachLayer(l=>{ const p=l.feature && l.feature.properties; const pid=p && (p.ID||p.MAIL_CODE||p.NAME_ENGLI); if(String(pid)===String(top.id)) targetLayer=l; });
  if(targetLayer){ map.fitBounds(targetLayer.getBounds(), { maxZoom:16, padding:[30,30] }); showSidebarFor('zone', targetLayer.feature.properties); }
});

// AI Analyze
analyzeBtn.addEventListener('click',()=>{
  const counts=computeCountsPerZone();
  const values=Object.values(counts);
  values.sort((a,b)=>a-b);
  const q25=values[Math.floor(values.length*0.25)]||0;
  lowZoneIds.clear();
  for(const [id,c] of Object.entries(counts)) if(c<=q25) lowZoneIds.add(String(id));
  zonesLayer.remove(); buildZonesLayer(); zonesLayer.addTo(map);
  if(lowZoneIds.size>0){
    const lowLayers=[];
    zonesLayer.eachLayer(l=>{ const pid=String(l.feature.properties.ID||l.feature.properties.MAIL_CODE||l.feature.properties.NAME_ENGLI||''); if(lowZoneIds.has(pid)) lowLayers.push(l); });
    if(lowLayers.length>0) map.fitBounds(L.featureGroup(lowLayers).getBounds(), { padding:[30,30] });
  }
});

// Auto Explore
autoExploreBtn.addEventListener('click', async ()=>{
  stopAutoExplore=false;
  const zones=zonesLayer.getLayers();
  const containers=containersLayer.getLayers();
  const sequence=[...zones,...containers];
  for(let i=0;i<sequence.length;i++){
    if(stopAutoExplore) break;
    const l=sequence[i];
    map.flyTo(l.getBounds ? l.getBounds().getCenter() : l.getLatLng(), 16, {duration:2});
    l.openPopup();
    showSidebarFor(l.feature.geometry.type==='Point'?'container':'zone', l.feature.properties);
    await new Promise(r=>setTimeout(r,2500));
  }
});

stopExploreBtn.addEventListener('click', ()=>{ stopAutoExplore=true; });

loadData();
</script>
</body>
</html>
